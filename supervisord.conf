; Supervisor main config and NapCat programs
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

; One-time init to set UID/GID, write configs, then signal readiness
[program:init]
command=/bin/bash -lc 'set -e; rm -f /tmp/.X1-lock || true; : "${NAPCAT_UID:=0}"; : "${NAPCAT_GID:=0}"; usermod -o -u "$NAPCAT_UID" napcat || true; groupmod -o -g "$NAPCAT_GID" napcat || true; usermod -g "$NAPCAT_GID" napcat || true; chown -R "$NAPCAT_UID:$NAPCAT_GID" /app || true; CONFIG_PATH=/app/napcat/config/webui.json; if [ ! -f "$CONFIG_PATH" ] && [ -n "$WEBUI_TOKEN" ]; then : "${WEBUI_PREFIX:=}"; printf "{\"host\":\"0.0.0.0\",\"prefix\":\"%s\",\"port\":6099,\"token\":\"%s\",\"loginRate\":3}" "$WEBUI_PREFIX" "$WEBUI_TOKEN" > "$CONFIG_PATH"; fi; if [ -n "$MODE" ] && [ -f "/app/templates/${MODE}.json" ]; then cp "/app/templates/${MODE}.json" "/app/napcat/config/onebot11.json"; fi; touch /app/.init_done'
autostart=true
autorestart=false
startsecs=0
priority=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:xvfb]
command=/bin/bash -lc 'while [ ! -f /app/.init_done ]; do sleep 0.2; done; exec /usr/bin/Xvfb :1 -screen 0 1080x760x16 +extension GLX +render'
user=napcat
autostart=true
autorestart=true
startsecs=2
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:qq]
; Wait for init marker; optional ACCOUNT
command=/bin/bash -lc 'while [ ! -f /app/.init_done ]; do sleep 0.2; done; if [ -n "$ACCOUNT" ]; then exec /opt/QQ/qq --no-sandbox -q "$ACCOUNT"; else exec /opt/QQ/qq --no-sandbox; fi'
user=napcat
environment=DISPLAY=":1",FFMPEG_PATH="/usr/bin/ffmpeg"
autostart=true
autorestart=true
startsecs=3
priority=20
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
